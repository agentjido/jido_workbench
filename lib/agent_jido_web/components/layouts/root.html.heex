<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content={get_csrf_token()} />

    <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />

    <script>
      (function() {
        var stored = localStorage.getItem('theme');
        var systemPrefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        var theme = stored === 'light' || stored === 'dark' ? stored : (systemPrefersLight ? 'light' : 'dark');

        if (theme === 'light') {
          document.documentElement.classList.add('light');
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    <script defer phx-track-static type="text/javascript" src={~p"/assets/app.js"}>
    </script>

    <%= if Application.get_env(:agent_jido, :enable_analytics) do %>
      <script
        defer
        data-domain={Application.get_env(:agent_jido, :canonical_host) || "agentjido.xyz"}
        src="https://plausible.io/js/script.outbound-links.js"
      >
      </script>
      <script>
        window.plausible = window.plausible || function() {
          (window.plausible.q = window.plausible.q || []).push(arguments)
        }
      </script>
    <% end %>

    <% default_description = "Agent Jido is the Elixir Autonomous Agent Framework"
    status = @conn.status
    canonical_allowed? = is_nil(status) or status == 200

    request_path =
      case @conn.request_path do
        path when is_binary(path) and path != "" -> path
        _ -> "/"
      end

    request_path =
      if request_path == "/", do: "/", else: String.trim_trailing(request_path, "/")

    endpoint_url = AgentJidoWeb.Endpoint.url()

    default_og_image =
      case request_path do
        "/" -> endpoint_url <> "/og/render/home"
        path -> endpoint_url <> "/og/render" <> path
      end

    default_canonical_url =
      if canonical_allowed? and is_binary(request_path) do
        endpoint_url <> request_path
      end

    canonical_url =
      if canonical_allowed? do
        assigns[:canonical_url] || default_canonical_url
      else
        nil
      end

    robots =
      case assigns[:robots] do
        nil ->
          nil

        value when is_binary(value) ->
          value

        value ->
          value
          |> List.wrap()
          |> Enum.map(&to_string/1)
          |> Enum.join(", ")
      end

    page_title = assigns[:page_title]

    meta_description =
      case assigns[:meta_description] do
        value when is_binary(value) ->
          if String.trim(value) == "", do: default_description, else: value

        _ ->
          default_description
      end

    og_description =
      case assigns[:og_description] do
        value when is_binary(value) ->
          if String.trim(value) == "", do: meta_description, else: value

        _ ->
          meta_description
      end

    seo_item = %{
      title: page_title,
      description: og_description,
      canonical_url: canonical_url,
      url: canonical_url,
      robots: robots
    }

    og_image = assigns[:og_image] || default_og_image %>

    <SEO.juice conn={@conn} config={AgentJidoWeb.SEO.config()} page_title={page_title} item={seo_item} />

    <meta property="og:image" content={og_image} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:image" content={og_image} />
  </head>
  <body class="antialiased font-mono">
    {@inner_content}
  </body>
</html>
